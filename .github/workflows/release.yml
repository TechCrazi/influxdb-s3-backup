# ~~ Generated by projen. To modify, edit .projenrc.js and run "npx projen".

name: Release
on:
  push:
    branches: main
  workflow_dispatch: {}
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Install dependencies
        run: yarn install --check-files --frozen-lockfile
      - name: Synthesize project files
        run: npx projen
      - name: Anti-tamper check
        run: git diff --exit-code
      - name: Set git identity
        run: |-
          git config user.name "Auto-bump"
          git config user.email "github-actions@github.com"
      - name: Bump to next version
        run: npx projen bump
      - name: Build
        run: npx projen build
      - name: Anti-tamper check
        run: git diff --exit-code
      - name: Push changes
        run: git push --follow-tags origin $BRANCH
        env:
          BRANCH: ${{ github.ref }}
      - name: Upload artifact
        uses: actions/upload-artifact@v2.1.1
        with:
          name: dist
          path: dist
  get_version:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: get_version
        run: |-
          JSON=$(cat ./version.json)
          echo "::set-output name=version::${JSON//'%'/'%25'}"
  publish_docker_hub:
    needs: get_version
    runs-on: ubuntu-latest
    env:
      CI: "true"
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: damadden88/influxdb-s3-backup:${{fromJson(needs.get_version.outputs.matrix).version}}
